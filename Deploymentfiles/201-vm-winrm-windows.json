{
   "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "adminUsername":{
         "type":"string",
         "defaultValue":"admin",
         "metadata":{
            "description":"Username for the Virtual Machine."
         }
      },
      "adminPassword":{
         "type":"securestring",
         "defaultValue":"Admin123456",
         "metadata":{
            "description":"Password for the Virtual Machine."
         }
      },
      "dnsLabelPrefix":{
         "type":"string",
         "defaultValue":"az3032skc1",
         "metadata":{
            "description":"Unique DNS Name for the Public IP used to access the Virtual Machine."
         }
      },
      "windowsOSVersion":{
         "type":"string",
         "defaultValue":"2012-R2-Datacenter",
         "allowedValues":[
            "2008-R2-SP1",
            "2012-Datacenter",
            "2012-R2-Datacenter"
         ],
         "metadata":{
            "description":"The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter."
         }
      },
      "vmName":{
         "type":"string",
         "defaultValue":"skc-1-VM",
         "metadata":{
            "description":"The name for the VM."
         }
      },
      "nicName":{
         "type":"string",
         "defaultValue":"skc-1-VMNic",
         "metadata":{
            "description":"The name for the VM's NIC."
         }
      },
      "virtualNetworkName":{
         "type":"string",
         "defaultValue":"skc-1-VNET",
         "metadata":{
            "description":"The name for the VM's VNET."
         }
      },
      "publicIPAddressName":{
         "type":"string",
         "defaultValue":"skc-1-PublicIP",
         "metadata":{
            "description":"The name for the VM's public IP."
         }
      },
      "subnetName":{
         "type":"string",
         "defaultValue":"skc-1-Subnet",
         "metadata":{
            "description":"The name for the VM's Subnet."
         }
      },
      "location":{
         "type":"string",
         "defaultValue":"[resourceGroup().location]",
         "metadata":{
            "description":"Location for all resources."
         }
      },
      "storageAccountName":{
         "type":"string",
         "defaultValue":"p4362546ssar"
      }
   },
   "variables":{
      "imagePublisher":"MicrosoftWindowsServer",
      "imageOffer":"WindowsServer",
      "nicName":"[parameters('nicName')]",
      "addressPrefix":"10.0.0.0/16",
      "subnetName":"[parameters('subnetName')]",
      "subnetPrefix":"10.0.0.0/24",
      "publicIPAddressName":"[parameters('publicIPAddressName')]",
      "publicIPAddressType":"Dynamic",
      "vmName":"[parameters('vmName')]",
      "vmSize":"Standard_B2ms",
      "virtualNetworkName":"[parameters('virtualNetworkName')]",
      "subnetRef":"[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('subnetName'))]",
      "apiVersion":"2015-06-15",
      "hostDNSNameScriptArgument":"[concat('*.',parameters('location'),'.cloudapp.azure.com')]",
      "networkSecurityGroupName":"default-NSG",
      "storageAccountName":"[toLower(parameters('storageAccountName'))]"
   },
   "resources":[
      {
         "type":"Microsoft.Storage/storageAccounts",
         "apiVersion":"2015-06-15",
         "name":"[variables('storageAccountName')]",
         "location":"[resourceGroup().location]",
         "tags":{
            "displayName":"[variables('storageAccountName')]",
            "ARMcreated":"True"
         },
         "properties":{
            "accountType":"Standard_LRS"
         }
      },
      {
         "apiVersion":"2015-06-15",
         "type":"Microsoft.Network/publicIPAddresses",
         "name":"[variables('publicIPAddressName')]",
         "location":"[parameters('location')]",
         "properties":{
            "publicIPAllocationMethod":"[variables('publicIPAddressType')]",
            "dnsSettings":{
               "domainNameLabel":"[parameters('dnsLabelPrefix')]"
            }
         }
      },
      {
         "comments":"Default Network Security Group for template",
         "type":"Microsoft.Network/networkSecurityGroups",
         "apiVersion":"2019-08-01",
         "name":"[variables('networkSecurityGroupName')]",
         "location":"[parameters('location')]",
         "properties":{
            "securityRules":[
               {
                  "name":"default-allow-3389",
                  "properties":{
                     "priority":1000,
                     "access":"Allow",
                     "direction":"Inbound",
                     "destinationPortRange":"3389",
                     "protocol":"Tcp",
                     "sourceAddressPrefix":"*",
                     "sourcePortRange":"*",
                     "destinationAddressPrefix":"*"
                  }
               },
               {
                  "name":"allow-5986",
                  "properties":{
                     "priority":1001,
                     "access":"Allow",
                     "direction":"Inbound",
                     "destinationPortRange":"5986",
                     "protocol":"Tcp",
                     "sourceAddressPrefix":"*",
                     "sourcePortRange":"*",
                     "destinationAddressPrefix":"*"
                  }
               },
               {
                  "name":"allow-5985",
                  "properties":{
                     "priority":1002,
                     "access":"Allow",
                     "direction":"Inbound",
                     "destinationPortRange":"5985",
                     "protocol":"Tcp",
                     "sourceAddressPrefix":"*",
                     "sourcePortRange":"*",
                     "destinationAddressPrefix":"*"
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"2015-06-15",
         "type":"Microsoft.Network/virtualNetworks",
         "name":"[variables('virtualNetworkName')]",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
         ],
         "properties":{
            "addressSpace":{
               "addressPrefixes":[
                  "[variables('addressPrefix')]"
               ]
            },
            "subnets":[
               {
                  "name":"[variables('subnetName')]",
                  "properties":{
                     "addressPrefix":"[variables('subnetPrefix')]",
                     "networkSecurityGroup":{
                        "id":"[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
                     }
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"2015-06-15",
         "type":"Microsoft.Network/networkInterfaces",
         "name":"[variables('nicName')]",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]",
            "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]"
         ],
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig1",
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "publicIPAddress":{
                        "id":"[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
                     },
                     "subnet":{
                        "id":"[variables('subnetRef')]"
                     }
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"2016-04-30-preview",
         "type":"Microsoft.Compute/virtualMachines",
         "name":"[variables('vmName')]",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
         ],
         "properties":{
            "hardwareProfile":{
               "vmSize":"[variables('vmSize')]"
            },
            "osProfile":{
               "computerName":"[variables('vmName')]",
               "adminUsername":"[parameters('adminUsername')]",
               "adminPassword":"[parameters('adminPassword')]"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"[variables('imagePublisher')]",
                  "offer":"[variables('imageOffer')]",
                  "sku":"[parameters('windowsOSVersion')]",
                  "version":"latest"
               },
               "osDisk":{
                  "createOption":"FromImage"
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
                  }
               ]
            }
         },
         "resources":[
            {
               "type":"Microsoft.Compute/virtualMachines/extensions",
               "name":"[concat(variables('vmName'),'/WinRMCustomScriptExtension')]",
               "apiVersion":"[variables('apiVersion')]",
               "location":"[parameters('location')]",
               "dependsOn":[
                  "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
               ],
               "properties":{
                  "publisher":"Microsoft.Compute",
                  "type":"CustomScriptExtension",
                  "typeHandlerVersion":"1.4",
                  "autoUpgradeMinorVersion":true,
                  "settings":{
                     "fileUris":[
                        "https://raw.githubusercontent.com/sayankc/azure-quickstart-templates/master/201-vm-winrm-windows/ConfigureWinRM.ps1",
                        "https://raw.githubusercontent.com/sayankc/azure-quickstart-templates/master/201-vm-winrm-windows/makecert.exe"
                     ],
                     "commandToExecute":"[concat('powershell -ExecutionPolicy Unrestricted -file ConfigureWinRM.ps1 ',variables('hostDNSNameScriptArgument'))]"
                  }
               }
            }
         ]
      }
   ]
}